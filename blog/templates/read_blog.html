{% extends 'base.html' %}

{% block content %}

<style>
  .circle-image {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 50px;
    overflow: hidden;
    border-radius: 50%;
  }
  
  .circle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ensures image fills container */
  }

  .circle-image-comment {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 40px;
    overflow: hidden;
    border-radius: 50%;
  }
  
  .circle-image-comment img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ensures image fills container */
  }
  #comment_user{
    color:black;
    text-transform:capitalize;
  }
  #author_name{
    color:black;
    text-transform:capitalize;
  }
  {% comment %} .replies {
      margin-left: 20px;
      display: none;
  } {% endcomment %}
  .fa-star:hover{
    
  }

  .replies.show {
      display: block;
  }
  .checked{
    color: red;
  }
  .unchecked{
    color:gray;
  }
  .rating{
    cursor:pointer;
  } 




  .checkbox-wrapper-12 {
    position: relative;
  }
  
  .checkbox-wrapper-12 > svg {
    position: absolute;
    top: -130%;
    left: -170%;
    width: 110px;
    pointer-events: none;
  }
  
  .checkbox-wrapper-12 * {
    box-sizing: border-box;
  }
  
  .checkbox-wrapper-12 input[type="checkbox"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    -webkit-tap-highlight-color: transparent;
    cursor: pointer;
    margin: 0;
  }
  
  .checkbox-wrapper-12 input[type="checkbox"]:focus {
    outline: 0;
  }
  
  .checkbox-wrapper-12 .cbx {
    width: 24px;
    height: 24px;
    top: calc(100px - 12px);
    left: calc(100px - 12px);
  }
  
  .checkbox-wrapper-12 .cbx input {
    position: absolute;
    top: 0;
    left: 0;
    width: 24px;
    height: 24px;
    border: 2px solid #bfbfc0;
    border-radius: 50%;
  }
  
  .checkbox-wrapper-12 .cbx label {
    width: 24px;
    height: 24px;
    background: none;
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 0;
    transform: trasnlate3d(0, 0, 0);
    pointer-events: none;
  }
  
  .checkbox-wrapper-12 .cbx svg {
    position: absolute;
    top: 5px;
    left: 4px;
    z-index: 1;
    pointer-events: none;
  }
  
  .checkbox-wrapper-12 .cbx svg path {
    stroke: #fff;
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke-dasharray: 19;
    stroke-dashoffset: 19;
    transition: stroke-dashoffset 0.3s ease;
    transition-delay: 0.2s;
  }
  
  .checkbox-wrapper-12 .cbx input:checked + label {
    animation: splash-12 0.6s ease forwards;
  }
  
  .checkbox-wrapper-12 .cbx input:checked + label + svg path {
    stroke-dashoffset: 0;
  }
  
  @-moz-keyframes splash-12 {
    40% {
      background: #866efb;
      box-shadow: 0 -18px 0 -8px #866efb, 16px -8px 0 -8px #866efb, 16px 8px 0 -8px #866efb, 0 18px 0 -8px #866efb, -16px 8px 0 -8px #866efb, -16px -8px 0 -8px #866efb;
    }
  
    100% {
      background: #866efb;
      box-shadow: 0 -36px 0 -10px transparent, 32px -16px 0 -10px transparent, 32px 16px 0 -10px transparent, 0 36px 0 -10px transparent, -32px 16px 0 -10px transparent, -32px -16px 0 -10px transparent;
    }
  }
  
  @-webkit-keyframes splash-12 {
    40% {
      background: #866efb;
      box-shadow: 0 -18px 0 -8px #866efb, 16px -8px 0 -8px #866efb, 16px 8px 0 -8px #866efb, 0 18px 0 -8px #866efb, -16px 8px 0 -8px #866efb, -16px -8px 0 -8px #866efb;
    }
  
    100% {
      background: #866efb;
      box-shadow: 0 -36px 0 -10px transparent, 32px -16px 0 -10px transparent, 32px 16px 0 -10px transparent, 0 36px 0 -10px transparent, -32px 16px 0 -10px transparent, -32px -16px 0 -10px transparent;
    }
  }
  
  @-o-keyframes splash-12 {
    40% {
      background: #866efb;
      box-shadow: 0 -18px 0 -8px #866efb, 16px -8px 0 -8px #866efb, 16px 8px 0 -8px #866efb, 0 18px 0 -8px #866efb, -16px 8px 0 -8px #866efb, -16px -8px 0 -8px #866efb;
    }
  
    100% {
      background: #866efb;
      box-shadow: 0 -36px 0 -10px transparent, 32px -16px 0 -10px transparent, 32px 16px 0 -10px transparent, 0 36px 0 -10px transparent, -32px 16px 0 -10px transparent, -32px -16px 0 -10px transparent;
    }
  }
  
  @keyframes splash-12 {
    40% {
      background: #866efb;
      box-shadow: 0 -18px 0 -8px #866efb, 16px -8px 0 -8px #866efb, 16px 8px 0 -8px #866efb, 0 18px 0 -8px #866efb, -16px 8px 0 -8px #866efb, -16px -8px 0 -8px #866efb;
    }
  
    100% {
      background: #866efb;
      box-shadow: 0 -36px 0 -10px transparent, 32px -16px 0 -10px transparent, 32px 16px 0 -10px transparent, 0 36px 0 -10px transparent, -32px 16px 0 -10px transparent, -32px -16px 0 -10px transparent;
    }
  }
</style>  


{% if messages %}
<div class="alert alert-primary" role="alert">
    {% for message in messages %}
    <p>{{ message }}</p>
    {% endfor %}
</div>
{% endif %}

<!-- <div class="container"> -->
<div class="row">
    <div class="col-md-8">
      <h2><b>{{blog_model.title}}</b></h2>
      <div class="d-flex justify-content-between">
        <div class="d-flex align-items-start">
          <div class="circle-image mr-3">
            {% if profile_info.avatar %}
              <img src="{{profile_info.avatar.url}}" alt="Image description">
            {% else %}
              <img src="https://upload.wikimedia.org/wikipedia/commons/b/bc/Unknown_person.jpg" alt="Image description">
            {% endif %}
          </div>
          <div class="align-self-center">
            <a id="author_name" href="{% url 'account:ProfileView' blog_model.user.id %}">{{blog_model.user.first_name}} {{blog_model.user.last_name}}&nbsp;</a><i class="fa-solid fa-pen-to-square"></i>
            <p>
              <i class="fa-solid fa-calendar-day"></i>&nbsp;<small>{{blog_model.created_at}}</small>
              &nbsp;
            </p>
          </div>
          &nbsp;
          <div class="align-self-center">
            {% if request.user == blog_model.user %}
              <a href="{% url 'blog:update_blog' blog_model.id %}" class="btn btn-secondary btn-sm">Edit</a>
              <a href="" data-toggle="modal" data-target="#exampleModal" class="btn btn-secondary btn-sm">Delete</a><br>
            {% endif %}
          </div>
        </div>
        <div>
          {% if request.user.is_authenticated %}
          <div class="checkbox-wrapper-12" data-blog-id="{{blog_model.id}}">
            <div class="cbx">
              <input {% if saved_blog %} checked="" {% endif %} type="checkbox" id="cbx-12">
              <label for="cbx-12"></label>
              <svg fill="none" viewBox="0 0 15 14" height="14" width="15">
                <path d="M2 8.36364L6.23077 12L13 2"></path>
              </svg>
            </div>
            
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <filter id="goo-12">
                  <feGaussianBlur result="blur" stdDeviation="4" in="SourceGraphic"></feGaussianBlur>
                  <feColorMatrix result="goo-12" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 22 -7" mode="matrix" in="blur"></feColorMatrix>
                  <feBlend in2="goo-12" in="SourceGraphic"></feBlend>
                </filter>
              </defs>
            </svg>
          </div>
          {% endif %}
        </div>
      </div>
      {% if blog_model.image %}
      <img src="{{blog_model.image.url}}" alt="superman" width="100%">
      {% endif %}
      <br><br>


      {{blog_model.content | safe}}
      <hr>
      <div>
        {% for i in blog_model_tags %}
          <span><a href="#">#{{i}}</a></span>
        {% endfor %}
      </div>
      <br>
      <div>
        <div class="d-flex flex-nowrap justify-content-around bd-highlight">
          <div>
            <a id="dataContainer" href="{% url 'blog:like_post' blog_model.id %}"><i id="like_icon" class="{% if like %}fa fa-solid fa-heart fa-xl checked{% else %}fa fa-regular fa-heart fa-xl unchecked{% endif %}"></i></a>&nbsp;<span id="likes" style="font-size: 1.2rem;">{{total_likes}}</span>
          </div>
          <form method="post" id="rating_form">
            {% csrf_token %}
            <div class="rating">
                <div>
                  <i class="fa-solid fa-star fa-xl" value="1" style="color: black;" title="click to give 1 raing"></i>
                  <i class="fa-solid fa-star fa-xl" value="2" style="color: black;" title="click to give 2 raing"></i>
                  <i class="fa-solid fa-star fa-xl" value="3" style="color: black;" title="click to give 3 raing"></i>
                  <i class="fa-solid fa-star fa-xl" value="4" style="color: black;" title="click to give 4 raing"></i>
                  <i class="fa-solid fa-star fa-xl" value="5" style="color: black;" title="click to give 5 raing"></i>  
                  <span id="total_rate_value">{{total_rate}}</span> rating by <span id="total_rate_user_value">{{total_rate_user}}</span>&nbsp;users
                </div>
            </div>
          </form>
        </div>
      </div>
    </div>


    <div class="col-md-4 border p-3">
      <form method="post">
        {% csrf_token %}
        {{ form }}
      </form>
      <form method="post" id="reply-form">
        {% csrf_token %}
        {% for form_fields in blog_comment_form %}
          {% if form_fields.name != 'name' %}
            {{ form_fields }}
          {% endif %}
        {% endfor %}
        <hr>
      </form>


      <div class="comment-section">
        <h3>Comment Section</h3><hr>
        <ol style="padding:0;list-style:none;">
        {% for comment in blog_comments %}
          {% if not comment.parent_comment %}
            <div data-parent-id="{{comment.id}}" class="border rounded p-2 m-1">
                <li style="padding:5">
                  <div>
                    <div class="d-flex flex-wrap">
                      <div class="circle-image-comment mr-2">
                        {% if comment.user.profiles.avatar %}
                          <img src="{{comment.user.profiles.avatar.url}}" alt="Image description">
                        {% else %}
                          <img src="https://upload.wikimedia.org/wikipedia/commons/b/bc/Unknown_person.jpg" alt="Image description">
                        {% endif %}
                      </div>
                      <div class="align-self-center">
                        <a id="comment_user" href="{% url 'account:ProfileView' comment.user.id %}">{{comment.user.first_name}} {{comment.user.last_name}}</a><br>
                      </div>
                    </div>
                  </div>
                  <div class="p-2">{{comment.comment}}</div>
                  <input type="hidden" id="parent_id" name="parent_id_comment" value="{{comment.id}}">
                    <span>
                      {% if request.user.is_authenticated %}&nbsp;&nbsp;<a href="#" class="reply-field"><u>reply</u></a>&nbsp;
                        {% if comment.user == request.user%}
                        <a href="" id="delete_comment" data-target="#parentCommentId" data-toggle="modal"><u>delete</u></a>
                        {% endif %}
                      {% endif %}
                    </span>
                </li>

                  <!-- Modal parent-comment deletion -->
                  <div class="modal fade" id="parentCommentId" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLabel">Delete blog</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <p>Are you sure you want to delete this comment, all reply will be deleted as well!</p>  
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">cancel</button>
                          <form method="post" action="{% url 'blog:DeleteComment' comment.id %}">
                            {% csrf_token %}
                            <!-- <button type="submit" data-blog-id="{{blog_model}}" class="btn btn-danger">delete</button> -->
                            <button type="submit" class="btn btn-secondary">delete</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>

                {% for j in blog_comments %}
                  {% if j.parent_comment == comment %}
                  <div data-child-id="{{j.id}}">
                    <li>
                      <ol style="list-style:none;">
                        <li class="m-1">
                          <div class="d-flex flex-wrap">
                            <div class="circle-image-comment mr-2">
                              {% if profile_info.avatar %}
                                <img src="{{profile_info.avatar.url}}" alt="Image description">
                              {% else %}
                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/bc/Unknown_person.jpg" alt="Image description">
                              {% endif %}
                            </div>
                            <div class="align-self-center">
                              <a id="comment_user" href="{% url 'account:ProfileView' j.user.id %}">{{j.user.first_name}} {{j.user.last_name}}<br></a>
                            </div>
                          </div>
                          <div class="p-2">{{j.comment}}</div>
                          <input type="hidden" name="child_id" value="{{j.id}}">
                          <span>{% if request.user.is_authenticated %}&nbsp;&nbsp;
                            <a href="#" class="reply-field">reply</a>&nbsp;<a href="" id="delete_comment" data-toggle="modal" data-target="#deleteCommentModal" ><u>delete</u></a>{% endif %}
                          </span>
                        </li>
                      </ol>
                    </li>
                  </div>

                  <!-- Modal child-comment deletion -->
                  <div class="modal fade" id="deleteCommentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLabel">Delete blog</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <p>Are you sure you want to delete this comment!</p>  
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">cancel</button>
                          <form method="post" action="{% url 'blog:DeleteComment' j.id %}">
                            {% csrf_token %}
                            <!-- <button type="submit" data-blog-id="{{blog_model}}" class="btn btn-danger">delete</button> -->
                            <button type="submit" class="btn btn-secondary">delete</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>

                  {% endif %}
                {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
        </ol>
      </div>
    </div>
</div>

<!-- Button trigger modal -->
<!-- <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#exampleModal">
  Launch demo modal
</button> -->

<!-- Modal blog deletion -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Delete blog</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this!</p>  
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">cancel</button>
        <form method="post" action="{% url 'blog:delete_blog' blog_model.id %}">
          {% csrf_token %}
          <!-- <button type="submit" data-blog-id="{{blog_model}}" class="btn btn-danger">delete</button> -->
          <button type="submit" class="btn btn-secondary">delete</button>
        </form>
      </div>
    </div>
  </div>
</div>



<script>

  document.addEventListener("DOMContentLoaded", function() {
    const replyLinks = document.querySelectorAll('.reply-field');
    replyLinks.forEach(function(link) {
      link.addEventListener('click', addReplyForm);
    });

    function addReplyForm(event) {
      event.preventDefault();
      const parentDiv = event.target.closest('div[data-parent-id]');
      const formExists = parentDiv.querySelector('.reply-form');
      if (!formExists) {
        // const hidden_input = document.createElement('input');
        // hidden_input.setAttribute('value',)
        const node = document.getElementById('parent_id');
        const clone = node.cloneNode(true);
        const form = document.createElement('form');
        // form.setAttribute()
        form.setAttribute('method', 'post');
        form.appendChild(clone);
        form.classList.add('reply-form');
        form.innerHTML = `
          {% csrf_token %}

          <div class="input-group mb-3">
            <input type="hidden" name="parent_comment_id" value="${parentDiv.dataset.parentId}">
            <input name="reply" type="text" class="form-control" placeholder="your reply" aria-label="Recipient's username" aria-describedby="button-addon2">
            <div class="input-group-append">
              <button class="btn btn-outline-secondary" type="submit" id="button-addon2">submit</button>
            </div>
          </div>

          `;
          parentDiv.appendChild(form);
        }
      }
    });

  document.getElementById('like_icon').addEventListener('click',(e)=>{
    e.preventDefault()
    fetch('{% url 'blog:like_post' blog_model.id %}')
    .then(response => response.json())
    .then(data => {
      if(data.status){
        document.getElementById('like_icon').setAttribute('class','fa-solid fa-heart fa-xl checked')
        document.getElementById('likes').innerHTML = data.total
      }else{
        document.getElementById('like_icon').setAttribute('class',"fa-regular fa-heart fa-xl unchecked")
        document.getElementById('likes').innerHTML = data.total
      }
    })
  })


  document.addEventListener("DOMContentLoaded",()=>{
    const star = document.querySelectorAll(".fa-star");

    for(let i = 0;i < {{avg_rate}};i++){
      if(star[i].getAttribute('value') <= {{avg_rate}}){
        star[i].setAttribute('class','fa-solid fa-star fa-xl');
        star[i].setAttribute('style','color:#FFD43B');
      }
    }

    //sending rating data using fetch api 
    const starList = Array.from(document.querySelectorAll(".fa-star"));
    starList.forEach(item =>{
      item.addEventListener("click",()=>{
        const ratingValue = item.getAttribute('value')
        const form = document.getElementById('rating_form')
        const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value
        fetch('{% url "blog:rateBlog" blog_model.id %}',{
          method:"POST",
          headers:{
            'Content-Type':'application/json',
            'X-CSRFToken': csrftoken
          },
          body:JSON.stringify({rating_value:ratingValue}),
        })
        .then(response => response.json())
        .then(data =>{
          console.log(data)
          document.getElementById('total_rate_value').textContent = data.total_rate_fetch;
          document.getElementById('total_rate_user_value').textContent = data.total_rate_user_fetch;
        })
      })
    })
  })

  document.addEventListener("DOMContentLoaded",()=>{
    var sel = document.querySelectorAll('.checkbox-wrapper-12');
    for(let i = 0;i < sel.length;i++){
      sel[i].addEventListener('click',(e)=>{
        const blog_id = sel[i].dataset.blogId;
        const url = "/save-link/"+blog_id+"/";
        console.log(url);
        fetch(url)
        .then(response => response.json())
        .then(data => console.log(data.status))
      })
    }
  })
</script>

{% endblock %}

